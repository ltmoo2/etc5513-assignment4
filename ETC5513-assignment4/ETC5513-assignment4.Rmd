---
title: "ETC5513-Assignment4"
author:
- familyname: Moody
  othernames: Lachlan
  address: Monash University
  email: ltmoo2@student.monash.edu.au
  correspondingauthor: true
  qualifications: Student:27809951
- familyname: 
  othernames: 
  address: Monash University
  email: 
  correspondingauthor: true
  qualifications:
- familyname: 
  othernames: 
  address: Monash University
  email: 
  correspondingauthor: true
  qualifications:
- familyname: 
  othernames: 
  address: Monash University
  email: 
  correspondingauthor: true
  qualifications:
department: Department of\newline Econometrics &\newline Business Statistics
organization: Acme Corporation
bibliography: references.bib
biblio-style: authoryear-comp
linestretch: 1.5
output:
  MonashEBSTemplates::report:
    fig_caption: yes
    fig_height: 5
    fig_width: 8
    includes:
      in_header: preamble.tex
    keep_tex: yes
    number_sections: yes
    citation_package: biblatex
    toc: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, cache=TRUE, messages=FALSE, warning=FALSE, fig.pos = 'H')

library(tidyverse)
library(ggplot2)
library(kableExtra)
library(here)
```


```{r readingdata, message = FALSE, warning = FALSE}
expectancy <- read_csv(here::here("data", "life_expectancy.csv"))
names(expectancy) <- paste(names(expectancy), expectancy[1, ], sep = "_") ## Merging first two header rows together to get row names
expectancy <- expectancy[-1,] ## Removing now unnecessary firt row

spend <- read_csv(here::here("data", "health_expenditure.csv"), skip = 1)

gdp <- read_csv(here::here("data", "gdp_data.csv"), skip = 3)

head(expectancy,10)
head(spend, 10)
head(gdp, 10)
```

 
\section*{Introduction}



\section*{Differences between men and women}

The disparity in the life expectancy between men and women was first recognised in the 1920's [@luy2014gender]. This section will examine this difference in detail.

The first step was to tidy the life expectancy data into a format R. The original variables were condensed into Country, Year, Type (expectancy measure), Gender and Expectancy. The first 10 resulting rows are displayed in Table \@ref(tab:transform). 

```{r transform}
expectancy_clean <- expectancy %>%
  pivot_longer(cols = `Life expectancy at birth (years)_Both sexes`:`Healthy life expectancy (HALE) at age 60 (years)_2_Female`,
               names_to = c("Type", "Gender"),
               names_sep = "_",
               values_to = "Expectancy") %>%
  mutate(Gender = if_else(Gender == "1", "Male",
                          if_else(Gender == 2, "Female", "Both"))) %>%
  rename(Country = X1_Country,
         Year = X2_Year) %>%
  mutate(Expectancy = as.numeric(Expectancy)) %>%
  mutate(Year = as.numeric(Year))

expectancy_clean %>%
  head(10) %>%
  kable(caption = "Life expectancy data") %>%
  kable_styling(bootstrap_options = c("striped", "bordered"))
```

An average was then calculated across the recorded gender types for life expectancy at birth which is shown in Table \@ref(tab:average). It appears that the average life expectancy for both genders is slightly over 69 years with females having the higher value of 71.6 years and males almost 5 years lower at 66.9 years.

```{r average}
averages <- expectancy_clean %>%
  filter(str_detect(Type, "Life expectancy at birth")) %>%
  group_by(Gender) %>%
  summarise("Average Life Expectancy" = mean(Expectancy, na.rm = TRUE))

averages %>%
  kable(caption = "Average life expectancy across genders", digits = 1) %>%
  kable_styling(bootstrap_options = c("striped", "bordered"))
```

The yearly averages were then visualised using the boxplot below in Figure \@ref(fig:box) with gender on the x-axis and the average life expectancy on the y-axis. This further illustrates that females on average have a higher life expectancy across all years in the data set, having a higher median and interquartile range than men with only the male maximum and female minimum values overlapping.

```{r box, fig.cap = "Comparison of life expectancy across genders per year"}

yearly_avg <- expectancy_clean %>%
  filter(str_detect(Type, "Life expectancy at birth")) %>%
  group_by(Gender, Year) %>%
  summarise(Average = mean(Expectancy, na.rm = TRUE))

yearly_avg %>%
  ggplot(aes(x = Gender,
             y = Average,
             colour = Gender)) +
  geom_boxplot() +
  theme_bw() +
  ylab("Average life expectancy")
```

A line graph was then produced with year on the x-axis and the average life expectancy on the y-axis to illustrate this trend. As can be seen in Figure \@ref(fig:test), across all years recorded in the data set, females have had a higher life expectancy than males by approximately the same amount.

```{r test, fig.cap = "Change in life expectancy by year for each gender"}

yearly_avg %>%
  ggplot(aes(x = Year,
             y = Average,
             group = Gender,
             colour = Gender)) +
  geom_line(size = 1) +
  ylab("Average Life Expectancy") +
  theme_bw()

```

A linear model was then produced to see if this trend was due to gender or year. The outputs are shown in Table \@ref(tab:linear). 

```{r linear}
library(broom)

reg_data <- yearly_avg %>%
  filter(Gender != "Both") %>%
  mutate(Year = Year-2000)

gender_reg <- lm(Average ~ Gender,
   data = reg_data)

exp_reg <-  lm(Average ~ Year,
   data = reg_data)

both_reg <- lm(Average ~ Gender + Year,
   data = reg_data)

gender_r <- glance(gender_reg) %>%
  select(r.squared, adj.r.squared) %>%
  mutate(Model = "Gender")

year_r <- glance(exp_reg) %>%
  select(r.squared, adj.r.squared) %>%
  mutate(Model = "Year")

both_r <- glance(both_reg) %>%
  select(r.squared, adj.r.squared) %>%
  mutate(Model = "Both")

reg_comp <- bind_rows(Gender = tidy(gender_reg),
          Year = tidy(exp_reg),
          Both = tidy(both_reg),
          .id = "Model") %>%
              left_join(bind_rows(gender_r, 
                      year_r, both_r),
            by = "Model") %>%
  select(Model,
         term, 
         estimate, 
         r.squared, 
         adj.r.squared)

reg_comp %>%
  kable(caption = "Model estimates for life expectancy based on gender and year", digits = 3) %>%
  kable_styling(bootstrap_options = c("striped", "bordered"))

```

Several insights are provided from this table. Firstly, the GenderMale term for the Gender model suggests that males on average live 4.7 years less than the female average of 71.6. Secondly, the Year term for the Year model shows that for each after 2000, people on average are living 0.35 years longer. Finally the adjusted.r.squared values describes the explanatory power of these models. The results have been plotted in Figure \@ref(fig:modelcomp) with the model name on the x-axis and the adjusted r squared on the y-axis.

```{r modelcomp, fig.cap = "Comparison of model fits"}
reg_comp %>%
  ggplot(aes(x = Model,
             y = adj.r.squared,
             colour = Model)) +
  geom_point(size = 3) +
  ylab("Adjusted r squared") +
  theme_bw()
```

This shows that the gender model is superior to the year mode, explaining over 64% of the variation in the life expectancy value compared to under 33% for the year variable. Interestingly, almost the entire variation in life expectancy can be explained by including both variables.

\section*{Differences betweetn countries}



\section*{Life expectancy at birth vs at 60}



\section*{Life expectancy and Gross Domestic Product}

